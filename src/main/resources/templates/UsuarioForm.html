<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Formulario de Datos</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

        <style>
            .error {
                border-color: red;
            }
            .correct{
                border-color: green;
            }
        </style>
    </head>

    <body class="container mt-4">

        <form method="post" th:object="${usuario}" th:action="@{/usuario/add}" class="p-4 border rounded shadow-sm bg-light">
            <h4 class="mb-4 text-primary"><i class="bi bi-person-square"></i> Datos del Usuario</h4>

            <input type="hidden" th:field="*{IdUsuario}">
            <input type="hidden" th:field="*{Direcciones[0].IdDireccion}">

            <div class="row g-3"
                 th:if="${(usuario.IdUsuario == 0 && usuario.Direcciones[0].IdDireccion == 0) 
                 || (usuario.IdUsuario != 0 && usuario.Direcciones[0].IdDireccion == -1)}">

                <!-- Nombre -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="NombreUsuario" placeholder="Nombre"
                               th:field="*{Nombre}">
                        <label for="NombreUsuario"><i class="bi bi-emoji-grin-fill"></i> Nombre</label>

                    </div>
                </div>

                <!-- Apellido Paterno -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="ApellidoPaterno" placeholder="Apellido Paterno"
                               th:field="*{ApellidoPaterno}" >
                        <label for="ApellidoPaterno"><i class="bi bi-gender-male"></i> Apellido Paterno</label>

                    </div>
                </div>

                <!-- Apellido Materno -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="ApellidoMaterno" placeholder="Apellido Materno"
                               th:field="*{ApellidoMaterno}">
                        <label for="ApellidoMaterno"><i class="bi bi-gender-female"></i> Apellido Materno</label>

                    </div>
                </div>

                <!-- Username -->
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="Username" placeholder="Username"
                               th:field="*{Username}" >
                        <label for="Username"><i class="bi bi-person-fill"></i> Username</label>

                    </div>
                </div>

                <!-- Email -->
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="email" class="form-control" id="Email" placeholder="Email"
                               th:field="${usuario.Email}" >
                        <label for="Email"><i class="bi bi-envelope-fill"></i> Email</label>

                    </div>
                </div>

                <!-- Password -->
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="Password" placeholder="Password"
                               th:field="${usuario.Password}" >
                        <label for="Password"><i class="bi bi-key"></i> Password</label>

                    </div>
                </div>

                <!-- Fecha Nacimiento -->
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="date" class="form-control" id="FechaNacimiento"
                               th:field="${usuario.FechaNacimiento}">
                        <label for="FechaNacimiento"><i class="bi bi-calendar"></i> Fecha Nacimiento</label>

                    </div>
                </div>

                <!-- Celular -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="Celular" placeholder="Celular"
                               th:field="*{Celular}">
                        <label for="Celular"><i class="bi bi-phone-fill"></i> Celular</label>
                    </div>
                </div>

                <!-- Telefono -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="Telefono" placeholder="Teléfono"
                               th:field="*{Telefono}">
                        <label for="Telefono"><i class="bi bi-telephone-fill"></i> Teléfono</label>
                    </div>
                </div>

                <!-- CURP -->
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="Curp" placeholder="CURP"
                               th:field="*{Curp}">
                        <label for="Curp"><i class="bi bi-file-earmark-text-fill"></i> CURP</label>
                    </div>
                </div>

                <!-- Rol -->
                <div class="col-md-4">
                    <label for="RolUsuario" class="form-label"><i class="bi bi-controller"></i> Rol</label>
                    <select class="form-select" id="RolUsuario" th:field="${usuario.Rol.IdRol}">
                        <option value="0">Selecciona un rol</option>
                        <option th:each="rol: ${rol}" th:text="${rol.Nombre}" th:value="${rol.IdRol}"></option>
                    </select>
                </div>

                <!-- Sexo -->
                <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-gender-ambiguous"></i> Sexo</label>
                    <div class="d-flex gap-4 mt-1">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sexo" id="sexoMasculino"
                                   th:field="${usuario.sexo}" value="M " >
                            <label class="form-check-label" for="sexoMasculino">Masculino</label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sexo" id="sexoFemenino" th:field="${usuario.sexo}" value="F ">
                            <label class="form-check-label" for="sexoFemenino">Femenino</label>
                        </div>
                    </div>
                    <div class="text-danger mt-1"
                         th:if="${#fields.hasErrors('Sexo')}" th:errors="${usuario.Sexo}"></div>
                </div>

            </div>


            <div class="row g-3" th:if="${(usuario.IdUsuario == 0 && usuario.Direcciones[0].IdDireccion == 0) 
                 || (usuario.IdUsuario != 0 && usuario.Direcciones[0].IdDireccion > 0) 
                 || (usuario.IdUsuario != 0 && usuario.Direcciones[0].IdDireccion == 0)}">
                <h4 class="mt-4 mb-3 text-primary"><i class="bi bi-house-door-fill"></i> Dirección</h4>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" class="form-control" placeholder="Calle" th:field="*{Direcciones[0].Calle}">
                        <label>Calle</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" placeholder="Número Exterior" th:field="*{Direcciones[0].NumeroExterior}">
                        <label>Número Exterior</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" placeholder="Número Interior" th:field="*{Direcciones[0].NumeroInterior}">
                        <label>Número Interior</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">País</label>
                    <select id="ddlPais" class="form-select">
                        <option value="0">Selecciona un País</option>
                        <option th:each="pais: ${pais}" th:text="${pais.Nombre}" th:value="${pais.IdPais}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select id="ddlEstado" class="form-select">
                        <option value="0">Selecciona un Estado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Municipio</label>
                    <select id="ddlMunicipio" class="form-select">
                        <option value="0">Selecciona un Municipio</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Colonia</label>
                    <select id="ddlColonia" class="form-select" th:field="*{Direcciones[0].Colonia.IdColonia}">
                        <option value="0">Selecciona una Colonia</option>
                    </select>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-floppy-fill"></i> Guardar</button>
            </div>
        </form>


        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

        <script>

            $(document).ready(function () {
                console.log("Ya prendí tu :)");

                // Cuando cambias el país
                $("#ddlPais").change(function () {
                    var idPais = $("#ddlPais").val();

                    // Limpiamos los dropdowns inferiores
                    $("#ddlEstado").empty().append("<option value='0' selected>Selecciona un Estado</option>");
                    $("#ddlMunicipio").empty().append("<option value='0' selected>Selecciona un Municipio</option>");
                    $("#ddlColonia").empty().append("<option value='0' selected>Selecciona una Colonia</option>");

                    if (idPais == 0)
                        return;

                    $.ajax({
                        url: "http://localhost:8080/api/estado/GetEstadoByPais/" + idPais,
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            if (data.Correct) {
                                $.each(data.Object, function (i, estado) {
                                    $("#ddlEstado").append("<option value='" + estado.idEstado + "'>" + estado.nombre + "</option>");
                                });
                            } else {
                                alert("No se pudieron cargar los estados: " + data.ErrorMessage);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener estados: " + textStatus);
                        }
                    });
                });

                // Cuando cambias el estado
                $("#ddlEstado").change(function () {
                    var idEstado = $("#ddlEstado").val();

                    // Limpiamos los dropdowns inferiores
                    $("#ddlMunicipio").empty().append("<option value='0' selected>Selecciona un Municipio</option>");
                    $("#ddlColonia").empty().append("<option value='0' selected>Selecciona una Colonia</option>");

                    if (idEstado == 0)
                        return;

                    $.ajax({
                        url: "http://localhost:8080/api/municipio/GetMunicipioByEstado/" + idEstado,
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            if (data.Correct) {
                                $.each(data.Object, function (i, municipio) {
                                    $("#ddlMunicipio").append("<option value='" + municipio.idMunicipio + "'>" + municipio.nombre + "</option>");
                                });
                            } else {
                                alert("No se pudieron cargar los municipios: " + data.ErrorMessage);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener municipios: " + textStatus);
                        }
                    });
                });

                // Cuando cambias el municipio
                $("#ddlMunicipio").change(function () {
                    var idMunicipio = $("#ddlMunicipio").val();

                    // Limpiamos el dropdown de colonias
                    $("#ddlColonia").empty().append("<option value='0' selected>Selecciona una Colonia</option>");

                    if (idMunicipio == 0)
                        return;

                    $.ajax({
                        url: "http://localhost:8080/api/colonia/GetColoniaByMunicipio/" + idMunicipio,
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            if (data.Correct) {
                                $.each(data.Object, function (i, colonia) {
                                    $("#ddlColonia").append("<option value='" + colonia.idColonia + "'>" + colonia.nombre + "</option>");
                                });
                            } else {
                                alert("No se pudieron cargar las colonias: " + data.ErrorMessage);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            alert("Error al obtener colonias: " + textStatus);
                        }
                    });
                });
            });

        </script>

    </body>
</html>

